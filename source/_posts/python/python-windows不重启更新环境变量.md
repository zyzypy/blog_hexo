---
title: windows通过powershell命令行更新环境变量不重启电脑
comments: true
toc: true
date: 2018-08-05 11:11:07
updated:
tags:
- windows
- 环境变量
- powershell
- 配置
- java
- python
categories:
- python
banner:
---
## 图形化配置
1. 桌面-此电脑>右键菜单-属性>界面左侧-高级系统设置>环境变量  或  控制面板>搜索“环境变量”
![](2.png)
2. 双击系统变量里面的"Path"，点击"新增"，添加目录。保存退出。
![](3.png)
![](4.png)

## 理解环境变量
### 定义
> 环境变量（environment variables）一般是指在操作系统中用来指定操作系统运行环境的一些参数。
### 使用场景
我们装java、python等开发工具时都要指定环境变量，虽然现在安装包一般会自动添加环境变量，但如果多版本共存、环境变量改变时还是需要手动设置的，总不能全靠重装太费时间。  
如果你有编程基础，相信很容易理解“参数”的意思。  
### ping命令例子
举个例子，不少人都用过“ping”命令来测试网络是否连通
![](1.png)
终端刚启动时的目录是 C:/Users/Win10， 这个目录下并没有ping相关的东西，但却能运行ping命令，其它目录亦然。
原理：上图前面图形化配置环境变量可以看到系统环境变量里有一条记录"C:/Windows/System32"。 当你输入"ping"时， 系统读取环境变量里事先定义好的目录，
然后在这些目录里查找ping命令。如果不配置环境变量，会报错"*xxx不是内部或外部命令,也不是可运行的程序或批处理文件*"，那么需要先CD到命令所在目录再执行比较麻烦。同理安装完一些开发工具后，也需要配置环境变量。
![](5.png)
### "用户环境变量"和"系统环境变量"
第二张图中可以看到有"用户环境变量"和"系统环境变量"，其实还有"进程环境变量"，我们主要看前两个。
"系统环境变量"是全局的、公共的，电脑开机就会加载；"用户环境变量"是局部的，哪个用户登录加载哪个用户的，我这里是"Win10"，你那里可能是"Administrator"。
### 环境变量优先级
"系统环境变量">"用户环境变量">变量中的每条记录按从上到下查找(例如同时安装了Python2和Python3，变量Path从上到下查找，终端输入命令python打开的解释器就可能不是你想要的版本，需要通过编辑Path移动目录改变顺序)


## 命令行配置
### (选做)备份
备份还是很有必要的（我之前测试命令直接覆盖了系统环境变量，还好重启电脑前在cmd中`echo %Path%`中恢复出来再通过命令重新写入）。
双击**Path**变量，选择“编辑文本”，把内容复制到txt中。或复制一份新建个环境变量取名为"Path-BAK"。
![](6.png)
![](7.png)
### 1. 打开powershell
系统左下windows徽标右键调出菜单(快捷键`Win` + `X`)或打开运行(快捷键`Win` + `X`)输入"powershell"。（cmd由于正在过时，不再叙述。）
### 2. (选做)查看现在的环境变量
```powershell
PS> $env:Path
```
打印结果跟图形化配置界面一致。
### 3. 通过.Net提供的语句直接写入
毕竟不是windows系开发者，资料不多，查下面几句话折腾了一会。
#### 写入用户环境变量
需要"**管理员**"权限的powershell。
```powershell
PS> [environment]::SetEnvironmentvariable("Path", ";c:\testt", "User")
```
在一个powershell网站找到了这个语句，第一个参数是要修改的变量，第二个参数为值，但三个参数为目标路径。
执行这句话后 “用户变量”会被修改。
![](14.png)
### 写入系统环境变量
但看之前安装的开发工具都写在系统变量中。于是尝试修改第三个参数，猜测system，结果报错给出正确答案是Machine。
**下面语句慎重执行，会覆盖原有的变量，先备份**
```powershell
PS> [environment]::SetEnvironmentvariable("Path", ";c:\testt", "Machine")
```
![](11.png)
这句话差点害我损失惨重，以为会追加内容，实际覆盖重写。  

→**所以正确的写法是**：
```powershell
PS> [environment]::SetEnvironmentvariable("Path", "$env:Path;c:\testt", "Machine")  
```
![](12.png)
然后通过图形界面发现命令写入了值。
![](13.png)


## 生效
添加或修改后的环境变量不会立即生效。
- 方法一：重启电脑。简单有效，只不过显得有点笨。
- 方法二（推荐）:
1. 环境变量随便赋一个值，不用害怕，这只是副本
```powersehll
PS> $env:path = 'foo'
``` 
![](23.png)
2. 关闭终端
3. 重新打开终端，测试修改的path已生效
原理：终端里终端里的Path只是一个副本，随意修改Path变量的值以触发生效，关闭终端再打开，环境变量就生效了。（cmd终端也可以做同样的事，cmd终端语法有所不同，不再叙述。）
- 方法三:(课外选做)如果安装了windows的包管理工具chocolaty,可以 `refeshenv`一条命令刷新环境。chocolaty安装教程详见{% post_link python/python-安装python3解释器 python-安装python3解释器 %}其中的内容。                                                                                                                           

## license
原创文章，转载注明出处，禁止商用                                                                                                                             